/**
 * Manejo de interacciones con las áreas del expediente
 */

// Función para mostrar notificaciones al usuario
function showAlert(message, type = 'info') {
    // Implementación básica - puedes usar tu sistema de notificaciones preferido
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Usar SweetAlert2 si está disponible, de lo contrario usar alert nativo
    if (typeof Swal !== 'undefined') {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            }
        });
        
        Toast.fire({
            icon: type === 'error' ? 'error' : type === 'success' ? 'success' : 'info',
            title: message
        });
    } else {
        alert(`${type.toUpperCase()}: ${message}`);
    }
}

/**
 * Abre el modal para subir un documento a un área específica
 * @param {string} areaId - ID del área
 * @param {string} areaNombre - Nombre del área
 */
window.abrirModalSubirDocumento = function(areaId, areaNombre) {
    console.log('Abriendo modal para subir documento al área:', areaId, areaNombre);
    
    // Actualizar el título del modal
    const modalTitulo = document.getElementById('subirDocumentoModalLabel');
    if (modalTitulo) {
        modalTitulo.textContent = `Subir documento a ${areaNombre || 'el área seleccionada'}`;
    }
    
    // Actualizar el campo oculto con el ID del área
    const areaIdInput = document.getElementById('area_id');
    if (areaIdInput) {
        areaIdInput.value = areaId;
    }
    
    // Mostrar el modal
    const modalElement = document.getElementById('subirDocumentoModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else {
        console.error('No se encontró el elemento del modal');
        showAlert('No se pudo abrir el modal de subida de documentos', 'error');
    }
};

/**
 * Carga los documentos de un área específica
 * @param {string} areaId - ID del área
 * @param {string} nombreArea - Nombre del área para mostrar
 */
window.cargarDocumentosArea = async function(areaId, nombreArea) {
    console.log('Cargando documentos para área:', areaId, nombreArea);
    
    // Validar parámetros
    if (!areaId) {
        console.error('Error: No se proporcionó un ID de área válido');
        showAlert('No se proporcionó un ID de área válido', 'error');
        return;
    }
    
    // Referencias a elementos del DOM
    const contenedor = document.getElementById('contenido-documentos');
    const bienvenida = document.getElementById('bienvenida-area');
    const contenidoArea = document.getElementById('contenido-area');
    const tituloAreaElement = document.getElementById('titulo-area-seleccionada');
    
    // Función para mostrar error
    const mostrarError = (mensaje) => {
        console.error('Error al cargar documentos:', mensaje);
        
        // Crear elementos DOM directamente
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger';
        
        const flexDiv = document.createElement('div');
        flexDiv.className = 'd-flex align-items-center';
        
        const icon = document.createElement('i');
        icon.className = 'bi bi-exclamation-triangle-fill me-2';
        
        const mensajeElement = document.createElement('span');
        mensajeElement.textContent = `Error al cargar documentos: ${mensaje}`;
        
        flexDiv.appendChild(icon);
        flexDiv.appendChild(mensajeElement);
        alertDiv.appendChild(flexDiv);
        
        // Limpiar el contenedor y mostrar el error
        if (contenedor) {
            contenedor.innerHTML = '';
            contenedor.appendChild(alertDiv);
        }
        
        // Mostrar botón de reintento
        const reintentarBtn = document.createElement('button');
        reintentarBtn.className = 'btn btn-outline-primary mt-3';
        reintentarBtn.innerHTML = '<i class="bi bi-arrow-repeat me-2"></i>Reintentar';
        reintentarBtn.onclick = () => window.cargarDocumentosArea(areaId, nombreArea);
        
        alertDiv.appendChild(document.createElement('br'));
        alertDiv.appendChild(reintentarBtn);
    };
    
    try {
        // Mostrar indicador de carga
        if (contenedor) {
            contenedor.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Cargando documentos del área...</p>
                </div>
            `;
        }
        
        // Ocultar bienvenida y mostrar contenido del área
        if (bienvenida) bienvenida.classList.add('d-none');
        if (contenidoArea) contenidoArea.classList.remove('d-none');
        
        // Actualizar el título del área
        if (tituloAreaElement) {
            tituloAreaElement.textContent = nombreArea || 'Documentos del área';
        }
        
        try {
            console.log('Cargando documentos para el área:', areaId);
            
            // Obtener el ID del expediente de la URL
            const urlParts = window.location.pathname.split('/');
            const expedienteId = urlParts[urlParts.length - 1];
            
            if (!expedienteId || isNaN(expedienteId)) {
                throw new Error('No se pudo obtener el ID del expediente de la URL');
            }
            
            // Hacer la petición a la ruta correcta
            const response = await fetch(`/expedientes/${expedienteId}/area/${areaId}/documentos/`, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                },
                credentials: 'same-origin'
            });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Error en la petición: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Documentos cargados:', data);
            
            if (data.success === false) {
                throw new Error(data.error || 'Error al cargar los documentos');
            }
            
            // Actualizar la interfaz con los documentos cargados
            if (contenedor) {
                if (data.documentos && data.documentos.length > 0) {
                    let html = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5>Documentos del área</h5>
                                <button class="btn btn-primary" onclick="abrirModalSubirDocumento('${areaId}', '${nombreArea.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-plus-lg me-1"></i> Agregar Documento
                                </button>
                            </div>
                            <div class="list-group mt-3">
                    `;
                    
                    data.documentos.forEach(doc => {
                        html += `
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <i class="bi ${doc.tipo === 'pdf' ? 'bi-file-earmark-pdf text-danger' : 'bi-file-earmark-text'}"></i>
                                    <span class="ms-2">${doc.nombre}</span>
                                </div>
                                <div>
                                    <a href="${doc.url}" class="btn btn-sm btn-outline-primary me-2" target="_blank">
                                        <i class="bi bi-eye"></i> Ver
                                    </a>
                                    <a href="${doc.url}" class="btn btn-sm btn-outline-secondary" download>
                                        <i class="bi bi-download"></i> Descargar
                                    </a>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                    
                    contenedor.innerHTML = html;
                } else {
                    contenedor.innerHTML = `
                        <div class="text-center py-5">
                            <i class="bi bi-folder-x display-1 text-muted mb-3"></i>
                            <h4>No hay documentos en esta área</h4>
                            <p class="text-muted mb-4">Aún no se han cargado documentos en esta área.</p>
                            <button class="btn btn-primary" onclick="abrirModalSubirDocumento('${areaId}', '${nombreArea.replace(/'/g, "\\'")}')">
                                <i class="bi bi-upload me-1"></i> Subir Primer Documento
                            </button>
                        </div>
                    `;
                }
            }
            
        } catch (error) {
            console.error('Error al cargar los documentos:', error);
            mostrarError('No se pudieron cargar los documentos. ' + error.message);
        }
        
    } catch (error) {
        console.error('Error inesperado:', error);
        mostrarError('Ocurrió un error inesperado: ' + error.message);
    }
};

// Inicialización
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando manejador de áreas...');
    
    // Asignar manejador de eventos a cada área
    document.querySelectorAll('.area-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const areaId = this.getAttribute('data-area-id');
            const areaNombre = this.getAttribute('data-area-nombre');
            
            // Actualizar la clase activa
            document.querySelectorAll('.area-item').forEach(i => i.classList.remove('active'));
            this.classList.add('active');
            
            // Cargar documentos del área
            if (window.cargarDocumentosArea) {
                window.cargarDocumentosArea(areaId, areaNombre);
            } else {
                console.error('La función cargarDocumentosArea no está definida');
                showAlert('Error al cargar los documentos: función no disponible', 'error');
            }
        });
    });
    
    // Cargar automáticamente el área activa
    const areaActiva = document.querySelector('.area-item.active');
    if (areaActiva && window.cargarDocumentosArea) {
        console.log('Cargando área activa por defecto');
        const areaId = areaActiva.getAttribute('data-area-id');
        const areaNombre = areaActiva.getAttribute('data-area-nombre');
        window.cargarDocumentosArea(areaId, areaNombre);
    }
    
    // Inicializar el formulario de subida de documentos
    const formSubirDocumento = document.getElementById('form-subir-documento');
    if (formSubirDocumento) {
        formSubirDocumento.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const btnSubmit = this.querySelector('button[type="submit"]');
            const spinner = this.querySelector('.spinner-border');
            
            try {
                // Mostrar indicador de carga
                btnSubmit.disabled = true;
                if (spinner) spinner.classList.remove('d-none');
                
                const response = await fetch('/api/documentos/subir/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken') || ''
                    }
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || 'Error al subir el documento');
                }
                
                // Mostrar mensaje de éxito
                showAlert('Documento subido correctamente', 'success');
                
                // Cerrar el modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('subirDocumentoModal'));
                if (modal) modal.hide();
                
                // Recargar los documentos del área actual
                const areaId = formData.get('area_id');
                const areaNombre = document.querySelector('.area-item.active')?.getAttribute('data-area-nombre') || '';
                if (areaId) {
                    window.cargarDocumentosArea(areaId, areaNombre);
                }
                
            } catch (error) {
                console.error('Error al subir el documento:', error);
                showAlert('Error al subir el documento: ' + error.message, 'error');
            } finally {
                // Restaurar el botón
                btnSubmit.disabled = false;
                if (spinner) spinner.classList.add('d-none');
            }
        });
    }
    
    // Función auxiliar para obtener el token CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
