{% load humanize %}
{% load dict_extras %}
<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Digitalización de Archivos</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --gradient-start: #f8f9fa;
            --gradient-end: #ffffff;
            --sidebar-bg: #f8f9fa;
            --glass-bg: #ffffff;
            --glass-border: #dee2e6;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
        }

        [data-theme="dark"] {
            --gradient-start: #2a2f38;
            --gradient-end: #f9f2d6;
            --sidebar-bg: #20252d;
            --glass-bg: #1a1a1a;
            --glass-border: rgba(75, 85, 99, 0.4);
            --text-primary: #ffffff;
            --text-secondary: #d1d5db;
            --text-muted: #9ca3af;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, var(--gradient-start) 0%, var(--gradient-end) 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }
        
        /* Remove underlines from all links */
        a {
            text-decoration: none;
        }
        
        /* Ensure links in buttons don't have underlines on hover */
        .quick-action-btn, .quick-action-btn:hover, .quick-action-btn:focus {
            text-decoration: none !important;
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            width: 100%;
            min-height: 100vh;
        }

        /* Sidebar */
        .dashboard-sidebar {
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 20px 20px 20px 25px;
            gap: 25px;
            box-shadow: inset -40px 0 60px -30px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .user-menu-sidebar {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid var(--glass-border);
            position: relative;
        }
        
        .sidebar-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 6px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
            text-decoration: none;
            flex: 1;
            text-align: center;
        }
        
        .action-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .action-btn .menu-icon,
        .action-btn .theme-icon {
            width: 16px;
            height: 16px;
        }

        [data-theme="dark"] .dashboard-sidebar {
            box-shadow: inset -40px 0 60px -30px rgba(0, 0, 0, 0.3);
        }

        .logo-text {
            font-weight: 300;
            font-size: 1.4em;
            line-height: 1.1;
            margin: 0;
            color: var(--text-primary);
        }

        .logo-subtext {
            font-weight: 300;
            font-size: 0.8em;
            padding-left: 5px;
            margin-top: 5px;
            opacity: 0.7;
            letter-spacing: 0.02em;
            display: block;
        }

        .dashboard-menu {
            margin-top: 20px;
            width: 100%;
            border-top: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            flex-direction: column;
        }

        [data-theme="dark"] .dashboard-menu {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #495057;
            padding: 10px 12px;
            font-weight: 400;
            font-size: 0.9em;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        [data-theme="dark"] .menu-item {
            color: rgba(255, 255, 255, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:hover {
            color: #212529;
            background: #f8f9fa;
        }

        [data-theme="dark"] .menu-item:hover {
            color: white;
            background: rgba(255, 255, 255, 0.15);
        }

        .menu-item.active {
            background: #1e40af;
            color: #ffffff;
            font-weight: 700;
        }

        [data-theme="dark"] .menu-item.active {
            background: #1e3a8a;
        }

        .menu-item.active::after {
            content: "";
            position: absolute;
            right: -25px;
            width: 0;
            height: 0;
            border-top: 20px solid transparent;
            border-bottom: 20px solid transparent;
            border-left: 12px solid #17245c;
            top: 50%;
            transform: translateY(-50%);
            filter: drop-shadow(-2px 0 1px rgba(0, 0, 0, 0.5));
        }

        [data-theme="dark"] .menu-item.active::after {
            border-left: 12px solid #121212cc;
        }

        .menu-icon {
            width: 18px;
            height: 18px;
        }

        /* Main content */
        .dashboard-main {
            display: flex;
            flex-direction: column;
            padding: 30px;
            overflow-y: auto;
            height: 100vh;
        }

        .dashboard-header {
            margin-bottom: 30px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border);
        }

        [data-theme="dark"] .dashboard-header {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .header-content-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            position: relative;
        }
        
        /* User Menu Styles */
        .user-menu-sidebar {
            position: relative;
        }
        
        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 6px 12px 6px 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            width: 100%;
        }
        
        .user-menu-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
        }
        
        .user-info {
            text-align: left;
            line-height: 1.2;
            display: none;
        }
        
        .user-name {
            font-weight: 500;
            font-size: 0.9em;
            color: var(--text-primary);
        }
        
        .user-role {
            font-size: 0.75em;
            color: var(--text-muted);
        }
        
        .user-menu-dropdown {
            position: absolute;
            right: 0;
            bottom: calc(100% + 10px);
            min-width: 200px;
            background: var(--glass-bg);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            padding: 8px 0;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.2s ease;
            z-index: 1000;
        }
        
        .user-menu-sidebar.active .user-menu-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .user-menu-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            color: var(--text-primary);
            font-size: 0.9em;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        .user-menu-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }
        
        .user-menu-item i {
            width: 20px;
            margin-right: 10px;
            text-align: center;
            color: var(--text-muted);
        }
        
        .user-menu-divider {
            height: 1px;
            background: var(--glass-border);
            margin: 8px 0;
        }
        
        /* Responsive styles */
        @media (min-width: 768px) {
            .user-info {
                display: block;
            }
            
            .user-menu-btn {
                padding: 6px 16px 6px 6px;
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            flex: 1;
        }

        .stat-card {
            padding: 12px 8px;
            text-align: center;
        }

        .stat-card h5 {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .stat-card h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 8px 0;
            color: var(--text-primary);
        }

        .stat-card small {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .theme-toggle-btn {
            background: #ffffff;
            border: 2px solid #667eea;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            flex-shrink: 0;
        }

        [data-theme="dark"] .theme-toggle-btn {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .theme-toggle-btn:hover {
            background: #f8f9fa;
            border-color: #5a67d8;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
        }

        [data-theme="dark"] .theme-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .theme-icon {
            width: 22px;
            height: 22px;
            stroke: #667eea;
            fill: none;
        }

        [data-theme="dark"] .theme-icon {
            stroke: var(--text-primary);
        }

        /* Content grid */
        .content-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            max-width: 100%;
        }

        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--glass-border);
        }

        [data-theme="dark"] .glass-card {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        .card-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .card-header h2 {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .select-input {
            background: #ffffff;
            border: 1px solid #ced4da;
            color: #212529;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
        }

        [data-theme="dark"] .select-input {
            background: rgba(45, 45, 45, 0.5);
            border: 1px solid var(--glass-border);
            color: var(--text-primary);
        }

        /* Chart */
        .chart-container {
            justify-content: space-between;
            height: 250px;
            gap: 12px;
        }

        .chart-bar-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            height: 100%;
        }

        .chart-bar-bg {
            width: 100%;
            background: rgba(75, 85, 99, 0.2);
            border-radius: 8px 8px 0 0;
            position: relative;
            flex: 1;
        }

        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            opacity: 0.9;
        }

        .chart-label {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* Sidebar Cards */
        .sidebar-cards {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .documents-today {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin: 1.25rem 0;
        }

        .doc-stat {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0.5rem;
            flex: 1;
            transition: transform 0.2s ease;
        }

        .doc-stat:hover {
            transform: translateY(-2px);
        }

        .doc-icon {
            width: 2.5rem;
            height: 2.5rem;
            padding: 0.5rem;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 0.5rem;
        }

        .doc-number {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.2;
        }

        .doc-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0.25rem 0 0 0;
        }

        .storage-footer {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-muted);
            padding-top: 0.75rem;
            border-top: 1px solid var(--glass-border);
            margin-top: 1rem;
        }

        .footer-icon {
            width: 1rem;
            height: 1rem;
            color: var(--text-muted);
        }

        .chart-value {
            font-size: 0.8em;
            color: var(--text-muted);
        }

        /* Users */
        .users-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar-wrapper {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9em;
        }

        .status-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 12px;
            height: 12px;
            border: 2px solid var(--glass-bg);
            border-radius: 50%;
        }

        .status-indicator.online {
            background: #10b981;
        }

        .status-indicator.away {
            background: #f59e0b;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
        }

        .user-role {
            font-size: 0.8em;
            color: var(--text-muted);
            margin: 0;
        }

        .user-time {
            font-size: 0.75em;
            color: var(--text-muted);
        }

        /* Estilos para la tabla de expedientes por tipo */
        .expedientes-tipo-table {
            font-size: 0.9em;
        }
        
        .tipo-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .tipo-table th, 
        .tipo-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .tipo-table th {
            font-weight: 500;
            color: #4b5563;
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .tipo-table tr:last-child td {
            border-bottom: none;
        }
        
        .tipo-table tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        
        [data-theme="dark"] .tipo-table tr:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Sección de expedientes por tipo debajo de la sección de Usuarios Conectados */
        .expedientes-tipo-section {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 20px;
        }

        .expedientes-tipo-section h2 {
            font-size: 1.2em;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
        }

        /* Estilos para la sección de actividad reciente y usuarios conectados */
        .activity-section {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            grid-column: 1 / -1;
            margin-bottom: 20px;
        }
        
        .activity-card, .users-card {
            display: flex;
            flex-direction: column;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
            padding: 16px;
            height: 250px; /* Altura reducida para ambas tarjetas */
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .activity-card {
            grid-column: 1 / 2;
        }
        
        .users-card {
            grid-column: 2 / 3;
        }

        .activity-card:hover, .users-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .activity-list, .users-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
            margin-right: -8px; /* Compensa el padding del scroll */
            max-height: calc(100% - 40px); /* Ajusta según la altura del título */
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* Estilos para la barra de desplazamiento */
        .activity-list::-webkit-scrollbar, 
        .users-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .activity-list::-webkit-scrollbar-track, 
        .users-list::-webkit-scrollbar-track {
            background: var(--border-color);
            border-radius: 10px;
        }
        
        .activity-list::-webkit-scrollbar-thumb, 
        .users-list::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        .activity-list::-webkit-scrollbar-thumb:hover, 
        .users-list::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
        
        .card-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .status-badge {
            background: var(--primary);
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .activity-card .card-title, .users-card .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        @media (max-width: 1024px) {
            .activity-section {
                grid-template-columns: 1fr;
            }
            
            .activity-card, .users-card {
                grid-column: 1 / -1;
                height: 250px; /* Altura reducida en móviles */
            }
        }

        .activity-list, .users-list {
            flex: 1;
            overflow-y: auto;
            padding-right: 4px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item, .user-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .activity-item:hover, .user-item:hover {
            background-color: var(--hover-bg);
        }

        .activity-item {
            border-bottom: 1px solid var(--border-color);
            padding: 10px 0;
            margin: 0 -8px;
            padding-left: 8px;
            padding-right: 8px;
        }

        .activity-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .activity-bullet {
            color: #1e40af;
            font-size: 1.2em;
            line-height: 1.6;
            margin-top: 6px;
            flex-shrink: 0;
            min-width: 8px;
            text-shadow: 0 0 5px rgba(30, 64, 175, 0.5);
        }

        .activity-content {
            flex: 1;
            min-width: 0;
        }

        .activity-action {
            font-size: 0.9em;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0 0 4px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .activity-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-secondary);
            font-size: 0.8em;
            gap: 8px;
        }

        .activity-time {
            color: var(--text-muted);
            font-size: 0.8em;
            white-space: nowrap;
            margin-left: 8px;
        }

        /* Estilos para la sección de Usuarios Conectados */
        .user-item {
            align-items: center;
            padding: 8px 8px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8em;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            display: flex;
            align-items: center;
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .status-badge {
            background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
            color: white;
            font-size: 0.7em;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 20px;
        }

        /* Estilos para las tarjetas */
        .activity-card,
        .users-card,
        .quick-actions-card,
        .quick-stats-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
            padding: 16px;
            margin-bottom: 20px;
            backdrop-filter: none !important;
            transition: all 0.3s ease;
        }

        /* Dark theme overrides */
        [data-theme="dark"] .activity-card,
        [data-theme="dark"] .users-card,
        [data-theme="dark"] .quick-actions-card,
        [data-theme="dark"] .quick-stats-card {
            background-color: hsla(0, 0%, 0%, 0.856) !important;
            border-color: #000000ef !important;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.952), 0 2px 4px -1px rgba(0, 0, 0, 0.2) !important;
        }

        /* Ensure text remains readable in dark mode */
        [data-theme="dark"] .card-title,
        [data-theme="dark"] .activity-item,
        [data-theme="dark"] .user-item {
            color: #e0e0e0 !important;
        }
        
        .quick-stats-card .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: var(--hover-bg);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.7em;
        }

        .quick-actions-card .card-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .action-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px 10px;
            border-radius: 8px;
            background: rgba(0, 51, 102, 0.9); /* Dark blue with opacity */
            transition: all 0.2s ease;
            text-align: center;
            text-decoration: none;
            color: white; /* White text */
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .action-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            background: rgba(0, 40, 85, 0.95); /* Slightly darker blue on hover */
            color: white;
        }

        .action-item:hover .action-icon {
            color: white;
        }

        .action-icon {
            font-size: 1.5em;
            margin-bottom: 6px;
            color: var(--primary);
            transition: all 0.2s ease;
        }

        .action-label {
            font-size: 0.7em;
            font-weight: 500;
            text-align: center;
            line-height: 1.2;
        }

        /* Sidebar cards */
        .sidebar-cards {
            grid-column: 2 / 3;
            grid-row: 1 / 2;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .documents-today {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
        }

        .doc-stat {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        [data-theme="dark"] .doc-stat {
            background: rgba(75, 85, 99, 0.2);
        }

        .doc-icon {
            width: 32px;
            height: 32px;
        }

        .doc-number {
            font-size: 1.4em;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .doc-label {
            font-size: 0.8em;
            color: var(--text-muted);
            margin: 0;
        }

        .storage-footer {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: var(--text-muted);
        }

        .footer-icon {
            width: 16px;
            height: 16px;
        }

        /* Quick actions */
        .quick-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 0.95em;
        }

        .quick-action-btn.primary {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
            transition: all 0.3s ease;
        }

        .quick-action-btn.primary:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, #1e3a8a 0%, #172554 100%);
            box-shadow: 0 6px 20px rgba(30, 64, 175, 0.4);
        }

        .quick-action-btn.secondary {
            background: #f8f9fa;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        [data-theme="dark"] .quick-action-btn.secondary {
            background: rgba(75, 85, 99, 0.3);
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
        }

        .quick-action-btn.secondary:hover {
            background: #e9ecef;
            color: #212529;
        }

        [data-theme="dark"] .quick-action-btn.secondary:hover {
            background: rgba(75, 85, 99, 0.5);
            color: var(--text-primary);
        }

        .btn-icon {
            width: 20px;
            height: 20px;
        }

        /* System info */
        .system-info {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .system-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .system-item {
            background: rgba(75, 85, 99, 0.15);
        }

        .system-item:hover {
            background: #e9ecef;
        }

        [data-theme="dark"] .system-item:hover {
            background: rgba(75, 85, 99, 0.25);
        }

        .system-icon {
            width: 20px;
            height: 20px;
        }

        .system-details {
            flex: 1;
        }

        .system-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin: 0 0 2px 0;
        }

        .system-value {
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .system-footer-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-top: 8px;
            border-top: 1px solid #dee2e6;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        [data-theme="dark"] .system-footer-info {
            border-top: 1px solid rgba(75, 85, 99, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .status-dot.online {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.5);
        }
        
        /* Estilos para la tarjeta de Expedientes por Tipo */
        .expedientes-tipo {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .tipo-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }
        
        .tipo-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .tipo-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .tipo-nombre {
            font-weight: 500;
            color: var(--text-color);
        }
        
        .tipo-cantidad {
            font-weight: 600;
            background: rgba(99, 102, 241, 0.2);
            color: #6366f1;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.8rem;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin-top: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            border-radius: 4px;
            transition: width 0.6s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .tipo-footer {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .total-expedientes {
            font-weight: 500;
            color: var(--text-color);
        }
        
        /* Connected Users Styles */
        .status-badge {
            background: #3b82f6;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background-color 0.2s;
        }
        
        .user-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .user-avatar-wrapper {
            position: relative;
            margin-right: 12px;
        }
        
        .status-indicator {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid var(--bg-color);
        }
        
        .status-indicator.online {
            background: #10b981;
        }
        
        .status-indicator.away {
            background: #f59e0b;
        }
        
        .user-info {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-weight: 500;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-role {
            color: #9ca3af;
            font-size: 0.8rem;
            margin: 0;
        }
        
        .user-time {
            font-size: 0.8rem;
            color: #9ca3af;
            white-space: nowrap;
            margin-left: 8px;
        }
        
        .no-users {
            padding: 20px;
            text-align: center;
            color: #9ca3af;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dashboard-container {
                grid-template-columns: 250px 1fr;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }

            .sidebar-cards {
                grid-column: 1 / 2;
                grid-row: auto;
            }

            .chart-card,
            .activity-card {
                grid-column: 1 / 2;
            }
        }

        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }

            .dashboard-sidebar {
                display: none;
            }

            .dashboard-main {
                padding: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header-content-wrapper {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-content">
                
                <h1 class="logo-text">
                    Secretaría de Servicios Públicos
                    <span class="logo-subtext">Digitalización de archivos</span>
                </h1>
            </div>

            <nav class="dashboard-menu" style="position: relative; top: -100px;">
                <a href="{% url 'digitalizacion:dashboard' %}" class="menu-item active">
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    Dashboard
                </a>
                <a href="{% url 'expedientes:lista_expedientes' %}" role="menuitem" class="menu-item" tabindex="0">
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                    </svg>
                    Expedientes
                </a>
                {% load role_tags %}
                {% if user|puede_crear_exp %}
                <a href="{% url 'expedientes:seleccionar_tipo' %}" role="menuitem" class="menu-item" tabindex="0">
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Crear
                </a>
                {% endif %}
                <a href="{% url 'digitalizacion:buscar_documentos' %}" role="menuitem" class="menu-item" tabindex="0" id="buscarDocumentoBtn">
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                    </svg>
                    Buscar Documento
                </a>
                <a href="{% url 'digitalizacion:reportes' %}" role="menuitem" class="menu-item" tabindex="0">
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    Reportes
                </a>
                {% if user|puede_administrar %}
                <a href="{% url 'areas:gestionar' %}" role="menuitem" class="menu-item" tabindex="0">
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    Áreas
                </a>
                <a href="{% url 'digitalizacion:panel_administracion' %}" role="menuitem" class="menu-item" tabindex="0">
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    Configuración
                </a>
            </nav>
            
            <!-- User Menu at bottom of sidebar -->
            <div class="user-menu-sidebar">
                <button id="userMenuBtn" class="user-menu-btn">
                    <div class="user-avatar">
                        {% if user.first_name and user.last_name %}
                            {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                        {% else %}
                            {{ user.username|first|upper }}
                        {% endif %}
                    </div>
                    <div class="user-info">
                        <div class="user-name">
                            {% if user.get_full_name %}
                                {{ user.get_full_name }}
                            {% else %}
                                {{ user.username }}
                            {% endif %}
                        </div>
                        <div class="user-role">
                            {% if user.is_superuser %}
                                Administrador
                            {% else %}
                                Usuario
                            {% endif %}
                        </div>
                    </div>
                    <svg class="menu-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </button>
                
                <div class="user-menu-dropdown">
                    <a href="{% url 'digitalizacion:perfil_usuario' %}" class="user-menu-item">
                        <i class="fas fa-user"></i>
                        <span>Mi perfil</span>
                    </a>
                    {% if user.is_staff %}
                    <a href="{% url 'digitalizacion:gestion_solicitudes' %}" class="user-menu-item">
                        <i class="fas fa-user-check"></i>
                        <span>Gestionar Solicitudes</span>
                    </a>
                    {% endif %}
                    {% if user|puede_aprobar %}
                    <a href="{% url 'digitalizacion:gestion_usuarios' %}" class="user-menu-item">
                        <i class="fas fa-users-cog"></i>
                        <span>Gestión de Usuarios</span>
                    </a>
                    {% endif %}
                    {% if user|puede_administrar %}
                    <a href="{% url 'digitalizacion:panel_administracion' %}" class="user-menu-item">
                        <i class="fas fa-cog"></i>
                        <span>Configuración</span>
                    </a>
                    {% endif %}
                    <div class="user-menu-divider"></div>
                    <a href="{% url 'digitalizacion:logout' %}" class="user-menu-item" style="color: #ef4444;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Cerrar sesión</span>
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Header with stats -->
            <div class="dashboard-header">
                <div class="header-content-wrapper">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h5>Expedientes</h5>
                            <h2>{{ total_expedientes|floatformat:0|intcomma }}</h2>
                            <small>Total registrados</small>
                        </div>
                        <div class="stat-card">
                            <h5>En Proceso</h5>
                            <h2>{{ expedientes_en_proceso|floatformat:0|intcomma }}</h2>
                            <small>Pendientes de revisión</small>
                        </div>
                        <div class="stat-card">
                            <h5>Completados</h5>
                            <h2>{{ expedientes_completados|floatformat:0|intcomma }}</h2>
                            <small>Procesados con éxito</small>
                        </div>
                        <div class="stat-card">
                            <h5>Rechazados</h5>
                            <h2>{{ expedientes_rechazados|floatformat:0|intcomma }}</h2>
                            <small>Requieren atención</small>
                        </div>
                    </div>

                    <button class="theme-toggle-btn" onclick="toggleTheme()" title="Cambiar Tema">
                        <svg class="theme-icon" id="themeIcon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Activity Chart -->
                <div class="glass-card chart-card">
                    <div class="card-header">
                        <h2>Actividad de la Semana</h2>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="activityChart"></canvas>
                    </div>
                    
                    <!-- Monthly Expedientes Chart -->
                    <div style="margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: var(--text-primary); margin: 0;">Expedientes por Mes</h3>
                            <button id="refreshMonthlyBtn" class="refresh-btn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
                                </svg>
                            </button>
                        </div>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="monthlyExpedientesChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Cards -->
                <div class="sidebar-cards">
                    <!-- Documents Uploaded Today -->
                    <div class="glass-card">
                        <h2 class="card-title">Documentos Subidos Hoy</h2>
                        <div class="documents-today">
                            <div class="doc-stat">
                                <svg class="doc-icon" fill="none" stroke="#3b82f6" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <div>
                                    <p class="doc-number">{{ total_documentos_hoy|default:"0" }}</p>
                                    <p class="doc-label">Documentos</p>
                                </div>
                            </div>
                            <div class="doc-stat">
                                <svg class="doc-icon" fill="none" stroke="#10b981" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <div>
                                    <p class="doc-number">{{ total_tamano_hoy_mb|default:"0" }} MB</p>
                                    <p class="doc-label">Tamaño total</p>
                                </div>
                            </div>
                        </div>
                        <div class="storage-footer">
                            <svg class="footer-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                            <span>{% if tiempo_ultima_subida == 'Nunca' %}{{ tiempo_ultima_subida }}{% else %}Última subida {{ tiempo_ultima_subida }}{% endif %}</span>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="glass-card">
                        <h2 class="card-title">Accesos Rápidos</h2>
                        <div class="quick-actions">
                            {% if user.perfil.rol.puede_crear_expedientes %}
                            <a href="{% url 'expedientes:seleccionar_tipo' %}" class="quick-action-btn primary">
                                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <span>Nuevo Expediente</span>
                            </a>
                            {% endif %}
                            <a href="{% url 'expedientes:lista_expedientes' %}" class="quick-action-btn secondary">
                                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                <span>Ver Expedientes</span>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Sección de Actividad Reciente y Usuarios Conectados -->
                <div class="activity-section">
                    <!-- Actividad Reciente -->
                    <div class="activity-card">
                        <div class="card-title">
                            <span>Actividad Reciente</span>
                            <span class="status-badge">{{ actividades_recientes|length|default:'0' }}</span>
                        </div>
                        <div class="activity-list">
                            {% for actividad in actividades_recientes|slice:":3" %}
                            <div class="activity-item">
                                <div class="activity-bullet">•</div>
                                <div class="activity-content">
                                    <p class="activity-action" title="{{ actividad.accion }}{% if actividad.expediente %} - {{ actividad.expediente.titulo|default:actividad.expediente.numero_expediente }}{% endif %}">
                                        {{ actividad.accion|truncatechars:40 }}
                                        {% if actividad.expediente %}
                                        - {{ actividad.expediente.titulo|default:actividad.expediente.numero_expediente|truncatechars:20 }}
                                        {% endif %}
                                    </p>
                                    <div class="activity-meta">
                                        <span>{{ actividad.usuario.get_full_name|default:actividad.usuario.username|truncatechars:20 }}</span>
                                        <span class="activity-time">Hace {{ actividad.fecha|timesince }}</span>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="activity-item">
                                <div class="activity-bullet">•</div>
                                <div class="activity-content">
                                    <p class="activity-action">No hay actividades recientes</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Usuarios Conectados -->
                    <div class="users-card" id="connected-users-card">
                        <div class="card-title">
                            <span>Usuarios Conectados</span>
                            <span class="status-badge" id="connected-users-count">{{ usuarios_conectados|default:'0' }}</span>
                        </div>
                        <div class="users-list" id="connected-users-list">
                            <div class="user-item">
                                <div class="user-avatar">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                                <div class="user-info">
                                    <div class="user-name">Cargando usuarios...</div>
                                    <div class="user-status">
                                        <span class="status-dot"></span>
                                        <span>Conectando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Acciones Rápidas -->
                    <div class="quick-actions-card">
                        <div class="card-title">
                            <span>Acciones Rápidas</span>
                            <i class="fas fa-bolt" style="color: var(--primary);"></i>
                        </div>
                        <div class="quick-actions-grid">
                            <a href="{% url 'expedientes:seleccionar_tipo' %}" class="action-item">
                                <i class="fas fa-plus-circle action-icon"></i>
                                <span class="action-label">Nuevo Expediente</span>
                            </a>
                            <a href="{% url 'expedientes:lista_expedientes' %}" class="action-item">
                                <i class="fas fa-search action-icon"></i>
                                <span class="action-label">Buscar</span>
                            </a>
                            <a href="{% url 'digitalizacion:reportes' %}" class="action-item">
                                <i class="fas fa-chart-bar action-icon"></i>
                                <span class="action-label">Reportes</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Estadísticas Rápidas -->
                    <div class="quick-stats-card">
                        <div class="card-title">
                            <span>Estadísticas Rápidas</span>
                            <i class="fas fa-chart-line" style="color: var(--primary);"></i>
                        </div>
                        <div class="quick-stats-grid">
                            <div class="stat-item">
                                <div class="stat-value">{{ total_expedientes|default:'0'|intcomma }}</div>
                                <div class="stat-label">Expedientes Totales</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ expedientes_en_proceso|default:'0'|intcomma }}</div>
                                <div class="stat-label">En Proceso</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ total_documentos_hoy|default:'0'|intcomma }}</div>
                                <div class="stat-label">Docs. Hoy</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">{{ usuarios_conectados|default:'0'|intcomma }}</div>
                                <div class="stat-label">Usuarios Activos</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Cards -->
                <div class="sidebar-cards">
                    <!-- Documents Uploaded Today -->
                    <div class="glass-card">
                        <h2 class="card-title">Documentos Subidos Hoy</h2>
                        <div class="documents-today">
                            <div class="doc-stat">
                                <svg class="doc-icon" fill="none" stroke="#3b82f6" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <div>
                                    <p class="doc-number">{{ total_documentos_hoy|default:"0" }}</p>
                                    <p class="doc-label">Documentos</p>
                                </div>
                            </div>
                            <div class="doc-stat">
                                <svg class="doc-icon" fill="none" stroke="#10b981" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <div>
                                    <p class="doc-number">{{ total_tamano_hoy_mb|default:"0" }} MB</p>
                                    <p class="doc-label">Tamaño total</p>
                                </div>
                            </div>
                        </div>
                        <div class="storage-footer">
                            <svg class="footer-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                            </svg>
                            <span>{% if tiempo_ultima_subida == 'Nunca' %}{{ tiempo_ultima_subida }}{% else %}Última subida {{ tiempo_ultima_subida }}{% endif %}</span>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="glass-card">
                        <h2 class="card-title">Accesos Rápidos</h2>
                        <div class="quick-actions">
                            {% if user.perfil.rol.puede_crear_expedientes %}
                            <a href="{% url 'expedientes:seleccionar_tipo' %}" class="quick-action-btn primary">
                                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                                </svg>
                                <span>Nuevo Expediente</span>
                            </a>
                            {% endif %}
                            <a href="{% url 'expedientes:lista_expedientes' %}" class="quick-action-btn secondary">
                                <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                </svg>
                                <span>Ver Expedientes</span>
                            </a>
                        </div>
                    </div>
                    
                    <!-- Expedientes por Tipo -->
                    <div class="glass-card" style="margin-top: 20px;">
                        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 class="card-title">Expedientes por Tipo</h2>
                            <span class="last-updated" id="expedientesLastUpdated" style="font-size: 0.8em; color: var(--text-muted);">Actualizando...</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                <thead>
                                    <tr>
                                        <th style="padding: 10px; text-align: left; border-bottom: 1px solid rgba(0,0,0,0.1);">Tipo de Expediente</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 1px solid rgba(0,0,0,0.1);">Cantidad</th>
                                    </tr>
                                </thead>
                                <tbody id="expedientesTipoBody">
                                    <tr>
                                        <td colspan="2" style="padding: 10px; text-align: center;">Cargando datos...</td>
                                    </tr>
                                </tbody>
                                <tfoot style="border-top: 2px solid rgba(0,0,0,0.1);">
                                    <tr>
                                        <td style="padding: 10px; font-weight: 600;">Total</td>
                                        <td style="padding: 10px; text-align: right; font-weight: 600;" id="totalExpedientes">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- User Menu Dropdown Toggle -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, initializing user menu...');
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userMenu = document.querySelector('.user-menu-sidebar');
        
        if (!userMenuBtn || !userMenu) {
            console.error('User menu elements not found');
            return;
        }
        
        console.log('User menu elements found, adding event listeners...');
        
        // Toggle dropdown menu
        userMenuBtn.addEventListener('click', function(e) {
            console.log('User menu button clicked');
            e.stopPropagation();
            userMenu.classList.toggle('active');
            console.log('Menu active state:', userMenu.classList.contains('active'));
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!userMenu.contains(e.target)) {
                userMenu.classList.remove('active');
            }
        });
        
        // Close dropdown when clicking on a menu item (except for logout)
        const menuItems = document.querySelectorAll('.user-menu-item:not([href*="logout"])');
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                userMenu.classList.remove('active');
            });
        });
    });
    </script>
    
    <script>
    // Function to load connected users via AJAX
    async function loadConnectedUsers() {
        try {
            const response = await fetch('{% url 'digitalizacion:api_usuarios_conectados' %}');
            const data = await response.json();
            
            if (data.status === 'success') {
                const container = document.getElementById('connected-users-list');
                const countElement = document.getElementById('connected-users-count');
                const card = document.getElementById('connected-users-card');
                
                // Update the count
                if (countElement) {
                    countElement.textContent = data.total;
                }
                
                // Clear loading state
                container.innerHTML = '';
                
                if (data.usuarios.length === 0) {
                    // Mostrar mensaje si no hay usuarios
                    container.innerHTML = `
                        <div class="user-item">
                            <div class="user-avatar">
                                <i class="fas fa-user-slash"></i>
                            </div>
                            <div class="user-info">
                                <div class="user-name">No hay usuarios conectados</div>
                                <div class="user-status">
                                    <span class="status-dot" style="background-color: #9ca3af;"></span>
                                    <span>Sin actividad</span>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Add each user to the list
                data.usuarios.forEach(user => {
                    const userInitial = user.nombre_completo ? user.nombre_completo.charAt(0).toUpperCase() : 'U';
                    const isActive = user.esta_activo;
                    const lastActivity = new Date(user.ultima_actividad);
                    const timeAgo = timeAgoFromDate(lastActivity);
                    
                    const userElement = document.createElement('div');
                    userElement.className = 'user-item';
                    userElement.innerHTML = `
                        <div class="user-avatar">
                            ${user.avatar_url 
                                ? `<img src="${user.avatar_url}" alt="${user.nombre_completo}" onerror="this.onerror=null; this.parentNode.innerHTML='${userInitial}'">` 
                                : userInitial
                            }
                        </div>
                        <div class="user-info">
                            <div class="user-name" title="${user.nombre_completo || 'Usuario'}">
                                ${user.nombre_completo || 'Usuario sin nombre'}
                            </div>
                            <div class="user-status">
                                <span class="status-dot" style="background-color: ${isActive ? '#10b981' : '#9ca3af'}"></span>
                                <span>${isActive ? 'En línea' : 'Inactivo'}</span>
                            </div>
                        </div>
                    `;
                    container.appendChild(userElement);
                });
            }
        } catch (error) {
            console.error('Error al cargar usuarios conectados:', error);
            const container = document.getElementById('connected-users-list');
            
            if (container) {
                container.innerHTML = `
                    <div class="user-item">
                        <div class="user-avatar">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="user-info">
                            <div class="user-name">Error de conexión</div>
                            <div class="user-status">
                                <span class="status-dot" style="background-color: #ef4444;"></span>
                                <span>No se pudieron cargar los usuarios</span>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
    }
    
    // Helper function to format time ago
    function timeAgoFromDate(date) {
        const now = new Date();
        const diffInSeconds = Math.floor((now - date) / 1000);
        
        if (diffInSeconds < 60) {
            return 'Hace unos segundos';
        } else if (diffInSeconds < 3600) {
            const minutes = Math.floor(diffInSeconds / 60);
            return `Hace ${minutes} min${minutes !== 1 ? 's' : ''}`;
        } else if (diffInSeconds < 86400) {
            const hours = Math.floor(diffInSeconds / 3600);
            return `Hace ${hours} hora${hours !== 1 ? 's' : ''}`;
        } else {
            const days = Math.floor(diffInSeconds / 86400);
            return `Hace ${days} día${days !== 1 ? 's' : ''}`;
        }
    }
    
    // Function to format numbers with thousands separators
    function formatNumber(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // Function to load expedientes por tipo data
    function loadExpedientesPorTipo() {
        fetch('/api/expedientes-por-tipo/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tbody = document.getElementById('expedientesTipoBody');
                    let total = 0;
                    
                    // Clear the table body
                    tbody.innerHTML = '';
                    
                    // Sort by quantity (descending)
                    const sortedData = [...data.data].sort((a, b) => b.total - a.total);
                    
                    // Add rows for each expediente type
                    sortedData.forEach(item => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="padding: 10px; border-bottom: 1px solid rgba(0,0,0,0.1);">${item.tipo}</td>
                            <td style="padding: 10px; text-align: right; border-bottom: 1px solid rgba(0,0,0,0.1);">${formatNumber(item.total)}</td>
                        `;
                        tbody.appendChild(row);
                        total += item.total;
                    });
                    
                    // Update the total
                    const totalElement = document.getElementById('totalExpedientes');
                    if (totalElement) {
                        totalElement.textContent = formatNumber(total);
                    }
                    
                    // Update the timestamp
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('es-ES', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    const lastUpdatedElement = document.getElementById('expedientesLastUpdated');
                    if (lastUpdatedElement) {
                        lastUpdatedElement.textContent = `Actualizado: ${timeString}`;
                    }
                } else {
                    console.error('Error loading expedientes por tipo:', data.error);
                    const tbody = document.getElementById('expedientesTipoBody');
                    if (tbody) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="2" style="padding: 10px; text-align: center; color: #ef4444;">
                                    Error al cargar los datos. Intente recargar la página.
                                </td>
                            </tr>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching expedientes por tipo:', error);
                const tbody = document.getElementById('expedientesTipoBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="2" style="padding: 10px; text-align: center; color: #ef4444;">
                                Error de conexión. Verifique su conexión a internet.
                            </td>
                        </tr>
                    `;
                }
            });
    }

    // Load data when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Load connected users
        loadConnectedUsers();
        
        // Load expedientes por tipo
        loadExpedientesPorTipo();
        
        // Refresh connected users every 30 seconds
        setInterval(loadConnectedUsers, 30000);
        
        // Refresh expedientes por tipo every 2 minutes
        setInterval(loadExpedientesPorTipo, 2 * 60 * 1000);
    });
    </script>
    
    <!-- Custom CSS for Connected Users -->
    <style>
        #connected-users-card {
            min-height: auto;
            max-height: 250px; /* Altura máxima reducida */
            transition: all 0.3s ease;
            overflow: hidden; /* Evita que el contenido se desborde */
        }
        
        #connected-users-card.empty {
            display: none;
        }
        
        .users-list {
            max-height: 200px; /* Altura reducida */
            overflow-y: auto;
            padding: 5px 0; /* Menos espacio interno */
        }
        
        .connected-user {
            display: flex;
            align-items: center;
            padding: 6px 8px; /* Padding reducido */
            border-bottom: 1px solid var(--glass-border);
            transition: background-color 0.2s;
            font-size: 0.85em; /* Texto un poco más pequeño */
        }
        
        .connected-user:last-child {
            border-bottom: none;
        }
        
        .connected-user:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        [data-theme="dark"] .connected-user:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .user-avatar {
            width: 32px; /* Tamaño reducido */
            height: 32px; /* Tamaño reducido */
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px; /* Margen reducido */
            font-weight: 600;
            color: #495057;
            font-size: 13px; /* Tamaño de fuente reducido */
            text-transform: uppercase;
            position: relative;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .user-status {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--glass-bg);
        }
        
        .user-status.online {
            background-color: #10b981;
        }
        
        .user-status.away {
            background-color: #f59e0b;
        }
        
        .user-status.offline {
            background-color: #9ca3af;
        }
        
        .user-details {
            flex: 1;
            min-width: 0;
        }
        
        .user-name {
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-activity {
            font-size: 0.8em;
            color: var(--text-muted);
            margin: 2px 0 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .status-badge {
            background-color: #3b82f6;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.8em;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
        }
        
        .refresh-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: var(--card-bg);
            color: var(--text-primary);
            transform: rotate(90deg);
        }
        
        .refresh-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .date-range {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: right;
            margin-top: 4px;
        }
        
        .no-users {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
        }
        
        .refresh-btn {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .refresh-btn:hover {
            background: var(--card-bg);
            color: var(--text-primary);
            transform: rotate(90deg);
        }
        
        .refresh-btn svg {
            width: 14px;
            height: 14px;
        }
    </style>
    
    <script>
        // Global chart instances
        let activityChart;
        let monthlyExpedientesChart;
        
        // Common chart options with modern gray and dark blue theme
        function getChartOptions(title) {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            // Color palette
            const colors = {
                // Text colors
                textPrimary: isDark ? '#f3f4f6' : '#111827',
                textSecondary: isDark ? '#9ca3af' : '#4b5563',
                // Grid & axis colors
                gridColor: isDark ? 'rgba(75, 85, 99, 0.2)' : 'rgba(209, 213, 219, 0.5)',
                // Accent colors (dark blue)
                accent: isDark ? '#3b82f6' : '#1e40af',
                accentLight: isDark ? 'rgba(30, 64, 175, 0.7)' : 'rgba(59, 130, 246, 0.7)',
                // Background colors
                tooltipBg: isDark ? '#1f2937' : '#ffffff',
                tooltipBorder: isDark ? '#374151' : '#e5e7eb',
                // Bar chart colors - solid dark blue for both themes
                barGradient: isDark 
                    ? ['#1e40af', '#1e3a8a', '#172554']
                    : ['#1e40af', '#1e3a8a', '#172554'],
                // Line chart colors - solid dark blue for both themes
                lineGradient: isDark
                    ? ['#1e40af', '#1e3a8a']
                    : ['#1e40af', '#1e3a8a']
            };
            
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        align: 'end',
                        labels: {
                            color: colors.textSecondary,
                            font: {
                                family: "'Roboto', sans-serif",
                                size: 12,
                                weight: 500
                            },
                            padding: 16,
                            usePointStyle: true,
                            boxWidth: 6,
                            boxHeight: 6
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: colors.tooltipBg,
                        titleColor: colors.textPrimary,
                        bodyColor: colors.textSecondary,
                        borderColor: colors.tooltipBorder,
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        cornerRadius: 6,
                        boxShadow: '0 4px 20px rgba(0, 0, 0, 0.1)',
                        callbacks: {
                            label: function(context) {
                                return ` ${context.parsed.y} ${title === 'weekly' ? 'expedientes' : 'documentos'}`;
                            },
                            title: function(context) {
                                return title === 'weekly' 
                                    ? `Semana ${context[0].label}`
                                    : context[0].label;
                            },
                            labelColor: function(context) {
                                return {
                                    borderColor: 'transparent',
                                    backgroundColor: context.dataset.borderColor || colors.accent,
                                    borderRadius: 2
                                };
                            }
                        },
                        titleFont: {
                            size: 12,
                            weight: 600,
                            family: "'Roboto', sans-serif"
                        },
                        bodyFont: {
                            size: 13,
                            weight: 400,
                            family: "'Roboto', sans-serif"
                        },
                        padding: 10,
                        caretSize: 6,
                        usePointStyle: true
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                },
                scales: {
                    x: {
                        grid: {
                            display: false,
                            drawBorder: false,
                            drawTicks: true,
                            tickLength: 4
                        },
                        ticks: {
                            color: colors.textSecondary,
                            font: {
                                size: 11,
                                family: "'Roboto', sans-serif",
                                weight: 500
                            },
                            padding: 8
                        }
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: colors.gridColor,
                            drawBorder: false,
                            drawTicks: false,
                            borderDash: [4, 4],
                            drawOnChartArea: true
                        },
                        ticks: {
                            color: colors.textSecondary,
                            font: {
                                size: 11,
                                family: "'Roboto', sans-serif",
                                weight: 500
                            },
                            padding: 8,
                            precision: 0,
                            callback: function(value) {
                                if (value % 1 === 0) return value;
                            }
                        }
                    }
                },
                elements: {
                    bar: {
                        borderRadius: 4,
                        borderSkipped: 'middle',
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;
                            
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            // Solid dark blue color
                            gradient.addColorStop(0, '#1e40af');
                            gradient.addColorStop(0.5, '#1e3a8a');
                            gradient.addColorStop(1, '#172554');
                            
                            return gradient;
                        },
                        borderWidth: 0,
                        hoverBackgroundColor: (context) => {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;
                            
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            // Solid dark blue hover color
                            gradient.addColorStop(0, '#1e3a8a');
                            gradient.addColorStop(1, '#172554');
                            
                            return gradient;
                        },
                        hoverBorderWidth: 0,
                        barPercentage: 0.8,
                        categoryPercentage: 0.8
                    },
                    line: {
                        tension: 0.35,
                        borderWidth: 2,
                        borderColor: (context) => {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;
                            
                            const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
                            // Solid dark blue line color
                            gradient.addColorStop(0, '#1e40af');
                            gradient.addColorStop(1, '#1e3a8a');
                            
                            return gradient;
                        },
                        backgroundColor: (context) => {
                            const chart = context.chart;
                            const {ctx, chartArea} = chart;
                            if (!chartArea) return null;
                            
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            // Darker blue background for better contrast
                            gradient.addColorStop(0, isDark ? 'rgba(30, 58, 138, 0.2)' : 'rgba(30, 58, 138, 0.2)');
                            gradient.addColorStop(0.8, 'rgba(30, 58, 138, 0.05)');
                            
                            return gradient;
                        },
                        fill: 'start',
                        pointBackgroundColor: colors.accent,
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: colors.accent,
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 2,
                        pointHitRadius: 10,
                        pointHoverBorderJoinStyle: 'round',
                        pointStyle: 'circle'
                    }
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart',
                    y: {
                        type: 'number',
                        easing: 'easeOutQuart',
                        from: (ctx) => {
                            if (ctx.type === 'data') {
                                return ctx.chart.scales.y.getPixelForValue(0);
                            }
                            return 0;
                        }
                    },
                    x: {
                        type: 'number',
                        easing: 'easeOutQuart',
                        from: (ctx) => {
                            if (ctx.type === 'data') {
                                return ctx.chart.scales.x.getPixelForValue(0);
                            }
                            return 0;
                        }
                    }
                },
                layout: {
                    padding: {
                        top: 8,
                        right: 16,
                        left: 8,
                        bottom: 8
                    }
                },
                // Add some spacing around the chart
                spacing: 8,
                // Better interaction settings
                interaction: {
                    intersect: false,
                    mode: 'nearest',
                    axis: 'x'
                },
                // Better legend interaction
                onHover: (event, chartElement) => {
                    event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                }
            };
        }
        
        
        // Initialize the monthly expedientes chart with modern styling
        function initMonthlyExpedientesChart() {
            const ctx = document.getElementById('monthlyExpedientesChart').getContext('2d');
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            monthlyExpedientesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Expedientes',
                        data: [],
                        borderWidth: 0,
                        borderRadius: 4,
                        barPercentage: 0.8,
                        categoryPercentage: 0.8,
                        // The actual colors will be set by the chart options
                    }]
                },
                options: getChartOptions('monthly')
            });
            
            // Load initial data
            loadMonthlyExpedientesData();
            
            // Add responsive behavior
            window.addEventListener('resize', function() {
                if (monthlyExpedientesChart) {
                    monthlyExpedientesChart.resize();
                }
            });
        }
        
        
        // Load monthly expedientes data
        function loadMonthlyExpedientesData() {
            fetch('/api/estadisticas/expedientes-mensuales/')
                .then(response => response.json())
                .then(data => {
                    if (data.success && monthlyExpedientesChart) {
                        monthlyExpedientesChart.data.labels = data.labels;
                        monthlyExpedientesChart.data.datasets[0].data = data.data;
                        monthlyExpedientesChart.update();
                        
                        // Show date range
                        const dateRange = document.createElement('div');
                        dateRange.className = 'date-range text-xs text-gray-500 text-right mt-1';
                        dateRange.textContent = `${data.start_date} al ${data.end_date}`;
                        
                        const container = document.getElementById('monthlyExpedientesChart').parentNode;
                        const existingRange = container.querySelector('.date-range');
                        if (existingRange) {
                            container.removeChild(existingRange);
                        }
                        container.appendChild(dateRange);
                    }
                })
                .catch(error => {
                    console.error('Error loading monthly expedientes data:', error);
                    showChartError('monthlyExpedientesChart', 'Error al cargar los datos mensuales');
                });
        }
        
        // Show error message in chart container
        function showChartError(chartId, message) {
            const chartContainer = document.getElementById(chartId);
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-4 text-center">
                        <svg class="w-10 h-10 text-red-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        <p class="text-red-500">${message}</p>
                        <button onclick="location.reload()" class="mt-2 px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                            Reintentar
                        </button>
                    </div>`;
            }
        }
        
        // Refresh weekly chart
        function refreshWeeklyChart() {
            const btn = document.getElementById('refreshWeeklyBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>`;
                
                loadWeeklyExpedientesData();
                
                // Re-enable button after animation
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
                        </svg>`;
                }, 1000);
            }
        }
        
        // Refresh monthly chart
        function refreshMonthlyChart() {
            const btn = document.getElementById('refreshMonthlyBtn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = `
                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>`;
                
                loadMonthlyExpedientesData();
                
                // Re-enable button after animation
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21.5 2v6h-6M21.34 15.57a10 10 0 1 1-.57-8.38"/>
                        </svg>`;
                }, 1000);
            }
        }
        
        // Update chart theme when theme changes
        function updateChartTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const textColor = isDark ? '#e5e7eb' : '#1f2937';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            if (activityChart) {
                activityChart.options.scales.x.ticks.color = isDark ? '#9ca3af' : '#6b7280';
                activityChart.options.scales.y.grid.color = isDark ? 'rgba(75, 85, 99, 0.2)' : 'rgba(209, 213, 219, 0.5)';
                activityChart.options.plugins.tooltip.backgroundColor = isDark ? '#1f2937' : '#ffffff';
                activityChart.options.plugins.tooltip.titleColor = isDark ? '#ffffff' : '#111827';
                activityChart.options.plugins.tooltip.bodyColor = isDark ? '#e5e7eb' : '#4b5563';
                activityChart.options.plugins.tooltip.borderColor = isDark ? '#374151' : '#e5e7eb';
                
                activityChart.data.datasets[0].backgroundColor = isDark ? 'rgba(99, 102, 241, 0.7)' : 'rgba(79, 70, 229, 0.7)';
                activityChart.data.datasets[0].borderColor = isDark ? 'rgba(129, 140, 248, 1)' : 'rgba(99, 102, 241, 1)';
                
                activityChart.update();
            }
            
            if (monthlyExpedientesChart) {
                monthlyExpedientesChart.options.scales.x.ticks.color = textColor;
                monthlyExpedientesChart.options.scales.y.ticks.color = textColor;
                monthlyExpedientesChart.options.scales.y.grid.color = gridColor;
                monthlyExpedientesChart.options.plugins.tooltip.backgroundColor = isDark ? '#1f2937' : '#ffffff';
                monthlyExpedientesChart.options.plugins.tooltip.titleColor = isDark ? '#ffffff' : '#111827';
                monthlyExpedientesChart.options.plugins.tooltip.bodyColor = isDark ? '#e5e7eb' : '#4b5563';
                monthlyExpedientesChart.options.plugins.tooltip.borderColor = isDark ? '#374151' : '#e5e7eb';
                
                monthlyExpedientesChart.update();
            }
        }
        
        // Initialize charts when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Initialize the daily activity chart
                fetch('/api/estadisticas/expedientes-semanales/')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Initialize the daily chart with the data
                            initializeChart(data);
                            
                            // Initialize the monthly expedientes chart
                            initMonthlyExpedientesChart();
                        } else {
                            console.error('Error en la respuesta de la API:', data.error || 'Error desconocido');
                            showChartError('activityChart', 'Error al cargar los datos del gráfico');
                        }
                    })
                    .catch(error => {
                        console.error('Error loading chart data:', error);
                        const chartContainer = document.getElementById('activityChart');
                        if (chartContainer) {
                            chartContainer.innerHTML = '<div class="text-center p-4 text-red-500">Error al cargar los datos del gráfico.</div>';
                        }
                    });
            } catch (e) {
                console.error('Error initializing chart:', e);
                // Show error message to user
                const chartContainer = document.getElementById('activityChart');
                if (chartContainer) {
                    chartContainer.innerHTML = '<div class="text-center p-4 text-red-500">Error al cargar el gráfico. Por favor, recargue la página.</div>';
                }
            }
        });
        
        // Initialize the chart with data using modern styling
        function initializeChart(chartData) {
            const ctx = document.getElementById('activityChart').getContext('2d');
            
            // Use the data from the API response
            const diasSemana = chartData.labels || ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
            const expedientesPorDia = chartData.data || [0, 0, 0, 0, 0, 0, 0];
            
            // Ensure we have valid data arrays
            if (!Array.isArray(diasSemana) || !Array.isArray(expedientesPorDia)) {
                console.error('Invalid chart data format');
                return;
            }
            
            // Create the chart with our common options
            activityChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: diasSemana,
                    datasets: [{
                        label: 'Expedientes',
                        data: expedientesPorDia,
                        // Styling is handled by the common options
                    }]
                },
                options: getChartOptions('weekly')
            });
            
            // Add responsive behavior
            window.addEventListener('resize', function() {
                if (activityChart) {
                    activityChart.resize();
                }
            });
            
            // Add click event for better interactivity
            if (ctx.canvas) {
                ctx.canvas.style.cursor = 'pointer';
                ctx.canvas.addEventListener('click', function(event) {
                    const points = activityChart.getElementsAtEventForMode(
                        event,
                        'nearest',
                        { intersect: true },
                        false
                    );
                    
                    if (points.length > 0) {
                        const firstPoint = points[0];
                        const label = activityChart.data.labels[firstPoint.index];
                        const value = activityChart.data.datasets[firstPoint.datasetIndex].data[firstPoint.index];
                        console.log(`Día: ${label}, Documentos: ${value}`);
                        // Aquí podrías agregar más interacciones al hacer clic
                    }
                });
            }
        }
        
        
        // Update chart theme when theme changes
        function updateChartTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            
            if (activityChart) {
                activityChart.options.scales.x.ticks.color = isDark ? '#9ca3af' : '#6b7280';
                activityChart.options.scales.y.grid.color = isDark ? 'rgba(75, 85, 99, 0.2)' : 'rgba(209, 213, 219, 0.5)';
                activityChart.options.plugins.tooltip.backgroundColor = isDark ? '#1f2937' : '#ffffff';
                activityChart.options.plugins.tooltip.titleColor = isDark ? '#ffffff' : '#111827';
                activityChart.options.plugins.tooltip.bodyColor = isDark ? '#e5e7eb' : '#4b5563';
                activityChart.options.plugins.tooltip.borderColor = isDark ? '#374151' : '#e5e7eb';
                
                activityChart.data.datasets[0].backgroundColor = isDark ? 'rgba(99, 102, 241, 0.7)' : 'rgba(79, 70, 229, 0.7)';
                activityChart.data.datasets[0].borderColor = isDark ? 'rgba(129, 140, 248, 1)' : 'rgba(99, 102, 241, 1)';
                
                activityChart.update();
            }
        }
        
        // Theme toggle functionality
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update icon
            const icon = document.getElementById('themeIcon');
            if (newTheme === 'dark') {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>';
            }
        }

        // Load saved theme on page load
        window.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const icon = document.getElementById('themeIcon');
            if (savedTheme === 'dark') {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>';
            }
        });
    </script>
</body>
</html>